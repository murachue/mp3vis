<html>

<head>
	<title>mp3vis</title>
	<style>
		* {
			margin: 0px;
			padding: 0px;
		}

		body {
			background: #111;
			color: #ddd;
		}
	</style>
</head>

<body>
	<p>hello
	<div id="dropbox" style="background: #ccc; color:#000; padding: 0px 2em;">
		drag here
		<p id="info">info shown here</p>
		<canvas id="wavescope" style="width: 100%; height: 100px;"></canvas>
		<p><a id="dlsample">download raw sample</a></p>
		<p><a id="playsample">play sample</a></p>
	</div>
	<script src="mp3vis.js"></script>
	<script>
		async function parse(ab) {
			const { frames, maindatas, soundframes } = await Mp3vis.parsefile(ab);

			document.getElementById("info").innerText = `${frames.length} / ${maindatas.length}`;

			const samples = Array(soundframes[0].length).fill(0).map((_, ch) => soundframes.flatMap(sf => sf[ch]));

			const canvas = document.getElementById("wavescope");
			const ctx = canvas.getContext("2d");
			canvas.width = samples[0].length;
			canvas.height = 100;
			ctx.fillStyle = "#222";
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			for (const param of [{ color: "#cfc", sample: samples[0] }, { color: "#ccf", sample: samples[1] }].slice(0, samples.length)) {
				ctx.strokeStyle = param.color;
				ctx.beginPath();
				ctx.moveTo(0, param.sample[0] * 50 + 50);
				param.sample.forEach((v, i) => {
					ctx.lineTo(i, v * 50 + 50)
				});
				ctx.stroke();
			}

			const s16pcm = new Int16Array(Array(samples[0].length).fill(0).flatMap((_, i) => samples.map(ch => Math.min(Math.max(ch[i], -1), 1) * 32767)));
			const url = URL.createObjectURL(new Blob([s16pcm.buffer], { type: "application/octet-stream" }));
			const a_dl = document.getElementById("dlsample");
			if (a_dl.href) {
				URL.revokeObjectURL(a_dl.href);
			}
			a_dl.href = url;

			const a_play = document.getElementById("playsample");
			a_play.href = "#";
			a_play.onclick = function () {
				const ctx = new AudioContext();
				const buf = ctx.createBuffer(samples.length, samples[0].length, [44100, 48000, 32000, null][frames[0].header.sampling_frequency]);
				Array(samples.length).fill(0).forEach((_, ch) => {
					const chbuf = buf.getChannelData(ch);
					samples[ch].forEach((e, i) => {
						chbuf[i] = e;
					});
				});
				const src = ctx.createBufferSource();
				src.buffer = buf;
				src.connect(ctx.destination);
				src.start();
			};
		}
		const it = document.getElementById("dropbox");
		it.addEventListener("dragover", (e) => {
			e.preventDefault();
		});
		it.addEventListener("drop", (e) => {
			e.preventDefault();
			const file = e.dataTransfer?.files?.[0];
			if (file) {
				file.arrayBuffer().then(parse);
			}
		});
		fetch("ah.mp3").then((r) => {
			if (r.ok) {
				r.arrayBuffer().then(parse);
			}
		});
	</script>
</body>

</html>
